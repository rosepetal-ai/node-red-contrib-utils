<script type="text/javascript">
    RED.nodes.registerType('rp-array-in', {
        category: 'RP Utils',
        color: '#87CEEB',
        defaults: {
            name: { value: "" },
            inputPath: { value: "payload" },
            inputPathType: { value: "msg" },
            arrayPositionType: { value: "num" },
            arrayPositionValue: { value: 0 }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-sign-in",
        label: function() {
            if (this.name) return this.name;
            
            const posDisplay = this.arrayPositionType === 'num' 
              ? this.arrayPositionValue 
              : `${this.arrayPositionType}.${this.arrayPositionValue}`;
            return `Array In [${posDisplay}]`;
        },
        oneditprepare: function() {
            // Set up TypedInput for input path
            $("#node-input-inputPath").typedInput({
                default: 'msg',
                types: ['msg', 'flow', 'global'],
                typeField: "#node-input-inputPathType"
            });
            
            // Set up TypedInput for array position
            $("#node-input-arrayPositionValue").typedInput({
                default: 'num',
                types: ['num', 'msg', 'flow', 'global'],
                typeField: "#node-input-arrayPositionType"
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="rp-array-in">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <hr>
    
    <div class="form-row">
        <label for="node-input-inputPath"><i class="fa fa-sign-in"></i> Input from</label>
        <input type="text" id="node-input-inputPath" style="width: 70%;">
        <input type="hidden" id="node-input-inputPathType">
    </div>
    
    <div class="form-row">
        <label for="node-input-arrayPositionValue"><i class="fa fa-sort-numeric-asc"></i> Array Position</label>
        <input type="text" id="node-input-arrayPositionValue" style="width: 70%;" placeholder="0">
        <input type="hidden" id="node-input-arrayPositionType">
    </div>
    
    <div class="form-tips">
        <b>Tip:</b> Array position can be a fixed number (starting from 0) or dynamically resolved from msg, flow, or global context. This determines where this data will be placed in the output array.
    </div>
</script>

<script type="text/x-red" data-help-name="rp-array-in">
    <p>Collects data from a specified input path and tags it for ordered array assembly with a position index.</p>
    
    <h3>Details</h3>
    <p>This node is designed to work with the rp-array-out node to create ordered arrays from multiple data sources. It extracts data from the specified input path and tags it with a position index, allowing multiple rp-array-in nodes to feed into a single rp-array-out node for ordered collection.</p>
    
    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Input from <span class="property-type">string</span></dt>
        <dd>The location to read data from. You can select between <code>msg</code>, <code>flow</code>, or <code>global</code> context. Defaults to <code>msg.payload</code>.</dd>
        <dt>Array Position <span class="property-type">number | msg | flow | global</span></dt>
        <dd>The index position (0, 1, 2...) where this data should be placed in the final array. Can be a fixed number or dynamically resolved from message properties, flow context, or global context. Must resolve to a non-negative integer.</dd>
    </dl>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">any</span></dt>
        <dd>Input message containing the data to be extracted. The actual data location is determined by the "Input from" property. The payload is only replaced when the input is set to <code>msg.payload</code>; otherwise it is left untouched.</dd>
    </dl>
    
    <h3>Outputs</h3>
    <p>The node passes through the original message with added metadata for array assembly. When the input path is <code>msg.payload</code> the payload is mirrored; for all other inputs the existing payload is preserved and only the metadata is updated.</p>
    <dl class="message-properties">
        <dt>meta.arrayPosition <span class="property-type">number</span></dt>
        <dd>The configured array position index.</dd>
        <dt>meta.arrayData <span class="property-type">any</span></dt>
        <dd>The data extracted from the specified input path.</dd>
    </dl>

    <h3>Examples</h3>
    <ul>
        <li><strong>Basic Array Assembly:</strong> Three rp-array-in nodes with positions 0, 1, 2 feeding into an rp-array-out will create: <code>[data0, data1, data2]</code></li>
        <li><strong>Dynamic Positioning:</strong> Set array position from <code>msg.index</code> to dynamically determine where data should be placed based on message content</li>
        <li><strong>Image Collection:</strong> Multiple image-in nodes → rp-array-in nodes (positions 0, 1, 2...) → rp-array-out → transform nodes that support arrays</li>
        <li><strong>Mixed Data Sources:</strong> Combine data from different context levels (msg, flow, global) into a single ordered array</li>
        <li><strong>Conditional Assembly:</strong> Use flow variables to set positions based on processing conditions or user preferences</li>
    </ul>

    <h3>Node Interactions</h3>
    <p><strong>Works with:</strong> Must be used with rp-array-out node for array assembly. Can receive data from any node that outputs to the specified input path.</p>
    <p><strong>Best Practice:</strong> Use sequential positions starting from 0, ensure each rp-array-in node connected to the same rp-array-out has a unique position.</p>

    <h3>Error Handling</h3>
    <p>If the input path contains no data or is invalid, the node will set <code>meta.arrayData</code> to <code>null</code> and display a warning.</p>
</script>
