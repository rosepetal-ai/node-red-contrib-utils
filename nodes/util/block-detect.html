<script type="text/javascript">
    (function() {
        RED.nodes.registerType('rp-block-detect', {
            category: 'RP Utils',
            color: '#F4C95D',
            defaults: {
                name: { value: "" },
                intervalMs: { value: 1000, required: true, validate: RED.validators.number() },
                thresholdMs: { value: 120, required: true, validate: RED.validators.number() },
                consecutive: { value: 1, required: true, validate: RED.validators.number() },
                cooldown: { value: 30000, required: true, validate: RED.validators.number() },
                showStats: { value: true }
            },
            inputs: 0,
            outputs: 0,
            icon: "font-awesome/fa-shield",
            label: function() {
                return this.name || "block detect";
            },
            oneditprepare: function() {
                $("#node-input-showStats").prop("checked", this.showStats !== false);
            },
            oneditsave: function() {
                this.showStats = $("#node-input-showStats").is(":checked");
            }
        });
    })();
</script>

<script type="text/x-red" data-template-name="rp-block-detect">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Event loop watchdog">
    </div>

    <div class="form-row">
        <label for="node-input-thresholdMs"><i class="fa fa-bolt"></i> Threshold (ms)</label>
        <input type="number" id="node-input-thresholdMs" min="1" step="10">
    </div>

    <div class="form-row">
        <label for="node-input-intervalMs"><i class="fa fa-clock-o"></i> Sample interval (ms)</label>
        <input type="number" id="node-input-intervalMs" min="100" step="100">
    </div>

    <div class="form-row">
        <label for="node-input-consecutive"><i class="fa fa-repeat"></i> Consecutive hits</label>
        <input type="number" id="node-input-consecutive" min="1" step="1">
    </div>

    <div class="form-row">
        <label for="node-input-cooldown"><i class="fa fa-hourglass-half"></i> Cooldown (ms)</label>
        <input type="number" id="node-input-cooldown" min="1000" step="1000">
    </div>

    <div class="form-row">
        <label></label>
        <input type="checkbox" id="node-input-showStats" checked>
        <label for="node-input-showStats" style="width: auto;">Show live delay metrics</label>
    </div>
</script>

<script type="text/x-red" data-help-name="rp-block-detect">
    <p>Continuously monitors Node-RED's event loop for blocking work that would slow down flows.</p>

    <h3>How it works</h3>
    <p>The node samples <code>monitorEventLoopDelay</code> (or falls back to timer drift) and raises an alert when the measured delay exceeds the configured threshold for a number of consecutive samples.</p>

    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Threshold (ms)<span class="property-type">number</span></dt>
        <dd>Maximum allowed event loop delay before the node treats a sample as blocking.</dd>
        <dt>Sample interval (ms)<span class="property-type">number</span></dt>
        <dd>How often to collect a measurement. Lower values catch spikes sooner but cost a little more CPU.</dd>
        <dt>Consecutive hits<span class="property-type">number</span></dt>
        <dd>Number of back-to-back samples that must exceed the threshold before an alert is emitted.</dd>
        <dt>Cooldown (ms)<span class="property-type">number</span></dt>
        <dd>Minimum time between alerts so your logs do not flood when something stays blocked.</dd>
        <dt>Show live delay metrics<span class="property-type">boolean</span></dt>
        <dd>Toggle live status text that displays the current average and max delay.</dd>
    </dl>

    <h3>Usage</h3>
    <p>Drop the node anywhere in a flow (it has no wires) to keep a lightweight background watchdog running. Use multiple instances with different thresholds if you want per-flow granularity.</p>
</script>
